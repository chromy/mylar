#!/usr/bin/env python3

import os
import sys
import argparse
import subprocess
import tempfile

TOOLS_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
ROOT_DIR = os.path.dirname(TOOLS_DIR)
TARGET_FILE = os.path.join(ROOT_DIR, "js", "schemas.tsx")

def main():
    description = "Ensure js/schemas.tsx matches output of './viz schemas'"
    parser = argparse.ArgumentParser(description=description)
    parser.add_argument("--check", action="store_true")
    args = parser.parse_args()

    # Generate schemas using ./viz schemas
    try:
        result = subprocess.run(
            ["./viz", "schemas"],
            cwd=ROOT_DIR,
            capture_output=True,
            text=True,
            check=True
        )
        generated_content = result.stdout
    except subprocess.CalledProcessError as e:
        print(f"Error running './viz schemas': {e}", file=sys.stderr)
        if e.stderr:
            print(e.stderr, file=sys.stderr)
        return 1
    except FileNotFoundError:
        print("Error: './viz' binary not found. Run 'go build ./cmd/viz' first.", file=sys.stderr)
        return 1

    # Format the generated content with prettier
    with tempfile.NamedTemporaryFile(mode='w', suffix='.tsx', delete=False) as temp_file:
        temp_file.write(generated_content)
        temp_file_path = temp_file.name
    
    format_result = subprocess.run(
        ["pnpm", "-C", ROOT_DIR, "exec", "prettier", "--write", temp_file_path],
        capture_output=True,
        text=True
    )
    
    if format_result.returncode == 0:
        # Read the formatted content back
        with open(temp_file_path, 'r') as f:
            generated_content = f.read()
    
    # Clean up temp file
    os.unlink(temp_file_path)

    # Read current content of js/schemas.tsx
    try:
        with open(TARGET_FILE, 'r') as f:
            current_content = f.read()
    except FileNotFoundError:
        current_content = ""

    # Compare contents
    if current_content == generated_content:
        return 0  # Files match, success

    if args.check:
        print(f"Error: {TARGET_FILE} does not match output of './viz schemas'", file=sys.stderr)
        
        # Write generated content to temporary file for diff
        with tempfile.NamedTemporaryFile(mode='w', suffix='.tsx', delete=False) as temp_file:
            temp_file.write(generated_content)
            temp_file_path = temp_file.name
        
        # Show diff
        try:
            diff_result = subprocess.run(
                ["diff", "-u", TARGET_FILE, temp_file_path],
                capture_output=True,
                text=True
            )
            if diff_result.stdout:
                print("\nDiff:", file=sys.stderr)
                print(diff_result.stdout, file=sys.stderr)
        except Exception:
            pass  # If diff fails, just continue
        finally:
            # Clean up temp file
            try:
                os.unlink(temp_file_path)
            except Exception:
                pass
        
        print("Run './tools/presubmit' without --check to fix.", file=sys.stderr)
        return 1
    else:
        # Write the generated content to the target file
        os.makedirs(os.path.dirname(TARGET_FILE), exist_ok=True)
        with open(TARGET_FILE, 'w') as f:
            f.write(generated_content)
        print(f"Updated {TARGET_FILE}")
        return 0

if __name__ == "__main__":
    sys.exit(main())